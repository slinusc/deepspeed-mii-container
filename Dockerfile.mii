FROM nvidia/cuda:12.2.2-devel-ubuntu20.04

ARG DEBIAN_FRONTEND=noninteractive

# Install system packages (including python3-dev, ninja-build, etc.)
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      python3 python3-pip python3-dev \
      git build-essential ninja-build && \
    rm -rf /var/lib/apt/lists/*

# Upgrade pip
RUN pip3 install --no-cache-dir --upgrade pip

# Install DeepSpeed-MII from GitHub
RUN pip3 install --no-cache-dir \
      git+https://github.com/microsoft/DeepSpeed-MII.git@main

# Install Pydantic v2, pydantic-settings, FastAPI/Uvicorn/ShortUUID/FastChat,
# **and** sentencepiece so Mistral’s tokenizer can load
RUN pip3 install --no-cache-dir \
      pydantic pydantic-settings \
      fastapi uvicorn shortuuid fastchat \
      sentencepiece

# Expose MII’s OpenAI-like port
EXPOSE 23333

# Entrypoint: run the OpenAI-compatible server
ENTRYPOINT ["python3", "-m", "mii.entrypoints.openai_api_server"]
CMD ["--host", "0.0.0.0", "--port", "23333"]
